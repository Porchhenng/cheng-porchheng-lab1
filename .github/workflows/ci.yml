name: Node.js CI (NPM)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'  # Changed from 'yarn' to 'npm'
    - name: Install dependencies
      run: npm ci  # Changed from 'yarn install --frozen-lockfile' to 'npm ci'
    - name: Lint code
      run: npm run lint  # Changed from 'yarn lint' to 'npm run lint'
    # - name: Run tests
    #   run: npm test 
    - name: Run tests and collect coverage
      run: npm test
      env:
          NODE_OPTIONS: --loader=@istanbuljs/esm-loader-hook

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.node-version }}
        path: coverage/lcov.info
        retention-days: 5
  deploy: # <--- NEW DEPLOYMENT JOB
    name: Deploy to Vercel
    needs: [build-and-test] # CRITICAL: Only runs after build-and-test is successful
    runs-on: ubuntu-latest
    
    # CRITICAL: Deployment should only happen when pushing to 'main'
    # and not on Pull Requests.
    if: github.ref == 'refs/heads/main' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Vercel Deployment Action
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          # This should be the name of the project you set up in Vercel
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }} 
          # The ID of your Vercel organization (optional, but recommended)
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }} 
          # The token we created in step 1
          vercel-token: ${{ secrets.VERCEL_TOKEN }} 
          # Deploy to the production alias (main domain)
          vercel-args: '--prod'

